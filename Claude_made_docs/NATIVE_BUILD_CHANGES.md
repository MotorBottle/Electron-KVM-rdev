# Native Build Changes Analysis

## Summary

When running `npm run build:native`, the napi-rs build system generates **platform-specific files** in the `native/rdev-grabber/` directory. This document explains what changes and whether those changes should be committed.

## Files Generated During Build

### 1. Platform-Specific Binary (`.node` files)

**NOT tracked in git** (ignored by `.gitignore` line 136: `native/**/*.node`)

These are compiled native Node.js addons, specific to your OS and architecture:

| Platform | Architecture | Generated File |
|----------|-------------|----------------|
| Windows | x64 | `index.win32-x64-msvc.node` |
| Windows | ia32 | `index.win32-ia32-msvc.node` |
| Windows | ARM64 | `index.win32-arm64-msvc.node` |
| macOS | x64 | `index.darwin-x64.node` |
| macOS | ARM64 | `index.darwin-arm64.node` |
| macOS | Universal | `index.darwin-universal.node` |
| Linux | x64 (glibc) | `index.linux-x64-gnu.node` |
| Linux | x64 (musl) | `index.linux-x64-musl.node` |
| Linux | ARM64 (glibc) | `index.linux-arm64-gnu.node` |
| Linux | ARM64 (musl) | `index.linux-arm64-musl.node` |

**What they are:**
- Compiled Rust code as a Node.js native addon
- Contains platform-specific machine code
- Different for each OS/architecture combination

**Should they be committed?**
- ❌ **NO** - They're binary files, platform-specific, and should be built on each platform
- ✅ Already ignored by `.gitignore`

**Current state:**
- `index.darwin-arm64.node` exists (590 KB) - built on macOS ARM64
- When you build on Windows x64, it creates `index.win32-x64-msvc.node` instead

---

### 2. JavaScript Loader (`index.js`)

**✅ IS tracked in git**

This file is auto-generated by napi-rs and provides:
- Platform detection logic
- Dynamic loading of the correct `.node` file based on OS/arch
- Fallback to npm packages if local `.node` file doesn't exist

**Content:**
- Lines 31-304: Platform/architecture switch statement
- Line 313: Exports `start_grab` and `stop_grab` functions

**Should it be committed?**
- ✅ **YES** - This file is platform-agnostic
- It's the same across all platforms
- Provides the loading logic for all `.node` variants

**Does it change during build?**
- ⚠️ **Potentially** - If the exported functions change (e.g., adding `set_keyboard_hook_enabled`)
- The file is regenerated on every build, but content should remain the same unless:
  - You add/remove exported functions in Rust
  - You change the napi-rs version
  - Platform support list changes

---

### 3. TypeScript Definitions (`index.d.ts`)

**✅ IS tracked in git**

This file provides TypeScript type definitions for the native module:

```typescript
export interface KeyEvent {
  key: string
  code: string
  eventType: string
  ctrl: boolean
  alt: boolean
  shift: boolean
  meta: boolean
  platformCode: number
  scanCode: number
  usbHid: number
}
export declare function start_grab(callback: (...args: any[]) => any): void
export declare function stop_grab(): void
```

**Should it be committed?**
- ✅ **YES** - Provides IDE autocomplete and type checking
- Platform-agnostic
- Changes only when you modify the Rust API

**Does it change during build?**
- ⚠️ **Potentially** - If you add/remove exported functions or change types
- Example: If you add `set_keyboard_hook_enabled()`, this file will update

---

### 4. Rust Build Artifacts (`native/target/`, `native/rdev-grabber/target/`)

**NOT tracked in git** (ignored by `.gitignore` line 132-133)

These contain:
- Intermediate compilation files
- Debug symbols
- Dependency builds
- Can be gigabytes in size

**Should they be committed?**
- ❌ **NO** - Always ignored, always rebuilt

---

### 5. Cargo.lock

**✅ IS tracked in git** (at `native/Cargo.lock`)

**Note:** `.gitignore` has a commented-out line (140) that would ignore it, but it's currently tracked.

**Should it be committed?**
- ✅ **YES** for applications (provides reproducible builds)
- ❌ **NO** for libraries (allows downstream to resolve dependencies)
- Since electron-kvm is an application, Cargo.lock should be committed

**Does it change during build?**
- ⚠️ **Potentially** - If dependencies are updated or added
- Lock file pins exact versions of all transitive dependencies

---

## Cross-Platform Build Workflow

### Scenario: Building on Windows After macOS Commit

**Starting state** (from macOS):
```
native/rdev-grabber/
├── index.js                     ✅ Committed
├── index.d.ts                   ✅ Committed
├── index.darwin-arm64.node      ❌ Ignored (not in repo)
└── Cargo.toml                   ✅ Committed
```

**After `npm run build:native` on Windows x64:**
```
native/rdev-grabber/
├── index.js                     ✅ May regenerate (check with git diff)
├── index.d.ts                   ✅ May regenerate (check with git diff)
├── index.win32-x64-msvc.node    ❌ Created (ignored by git)
└── Cargo.toml                   ✅ Unchanged
```

**What shows in `git status`:**
- If `index.js` or `index.d.ts` changed → Shows as modified
- `.node` files → Not shown (ignored)
- `target/` folder → Not shown (ignored)

---

## Problem: Platform-Specific Commits

### Issue

If you commit `index.js` or `index.d.ts` after every build, and they contain platform-specific differences (they shouldn't, but napi-rs might vary slightly), you could get:

```
Commit A (macOS):  index.js exports [start_grab, stop_grab]
Commit B (Windows): index.js exports [start_grab, stop_grab]  # Same content
Commit C (macOS):  index.js exports [start_grab, stop_grab]  # But differs in whitespace/comments?
```

### Solution

**Check after building on Windows:**

```bash
npm run build:native
git diff native/rdev-grabber/index.js
git diff native/rdev-grabber/index.d.ts
```

**If no changes:**
- ✅ Good! The files are platform-agnostic

**If there are changes:**
- Review the diff carefully
- If only function additions (e.g., adding `set_keyboard_hook_enabled`):
  - ✅ Commit the changes - this is a legitimate API update
- If mysterious whitespace/comment changes:
  - ⚠️ Investigate - might be napi-rs version mismatch
  - Consider pinning napi-rs version in `package.json`

---

## Recommended Git Workflow

### 1. After Modifying Rust Code

```bash
# Build on your platform
npm run build:native

# Check what changed
git status
git diff native/rdev-grabber/index.js
git diff native/rdev-grabber/index.d.ts

# Only commit if API changed
git add native/rdev-grabber/index.js   # Only if exports changed
git add native/rdev-grabber/index.d.ts  # Only if types changed
git add native/rdev-grabber/src/        # Always commit Rust source
git commit -m "Add new native function"
```

### 2. Clean Rebuild

```bash
# Remove all generated files
rm -rf native/target
rm -rf native/rdev-grabber/target
rm -f native/rdev-grabber/*.node

# Rebuild
npm run build:native
```

### 3. Verify Cross-Platform Compatibility

```bash
# After building on one platform, check git
git diff native/rdev-grabber/

# If index.js or index.d.ts changed unexpectedly:
git diff native/rdev-grabber/index.js

# If the diff looks wrong, investigate napi-rs versions
cd native/rdev-grabber
npm list @napi-rs/cli
```

---

## Current State Analysis

Based on the repository state:

| File | Tracked | Size | Platform-Specific? | Notes |
|------|---------|------|-------------------|-------|
| `index.js` | ✅ Yes | 9 KB | ❌ No | Platform detection logic |
| `index.d.ts` | ✅ Yes | 396 B | ❌ No | TypeScript definitions |
| `index.darwin-arm64.node` | ❌ No | 590 KB | ✅ YES | macOS ARM64 binary |
| `Cargo.lock` | ✅ Yes | - | ❌ No | Dependency lock file |
| `target/` | ❌ No | Large | ✅ YES | Build artifacts |

**Verdict:**
- ✅ Correctly ignoring platform-specific binaries
- ✅ Correctly tracking platform-agnostic loader
- ✅ Correctly tracking TypeScript definitions

---

## Answer to Your Question

> "Help me check if there were platform specific changes made to the files during build"

**When you run `npm run build:native` on Windows:**

1. **`index.win32-x64-msvc.node`** - ✅ **Platform-specific** - Created (but ignored by git)
2. **`index.js`** - ❌ **NOT platform-specific** - Should be identical to macOS version
3. **`index.d.ts`** - ❌ **NOT platform-specific** - Should be identical to macOS version
4. **`target/`** folders - ✅ **Platform-specific** - Created (but ignored by git)

**To verify:**

After building on Windows, run:
```bash
git diff
```

**Expected result:**
- No changes (if you didn't modify the Rust API)

**If you see changes:**
- Check if you added/removed functions → Legitimate change
- Check if it's whitespace/formatting → Possible napi-rs version issue

**Current recommendation:**
- The setup is correct
- `.node` files are properly ignored
- `index.js` and `index.d.ts` should not have platform-specific changes unless you modify the API
